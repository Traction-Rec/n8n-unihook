# Mock Jira API server for integration tests
#
# WHY THIS IS NEEDED:
#
#   n8n's Jira Trigger node (n8n-nodes-base.jiraTrigger) unconditionally calls
#   the Jira REST API to register/deregister webhooks whenever a workflow is
#   activated or deactivated. This is hardcoded in the node's webhookMethods
#   lifecycle hooks (see JiraTrigger.node.ts checkExists/create/delete) and
#   there is NO environment variable or configuration option to disable it.
#
#   If these API calls fail (e.g. no Jira instance is reachable), the workflow
#   activation fails entirely â€” n8n does not gracefully degrade.
#
#   This nginx mock provides the minimal set of Jira API responses needed for
#   workflow activation to succeed without a real Jira instance.
#
# HOW IT WORKS WITH THE "DUD" CREDENTIAL:
#
#   The test setup script (scripts/run-integration-tests.sh) creates a
#   jiraSoftwareCloudApi credential in n8n with its domain pointed at this
#   mock server (http://mock-jira:8080). When n8n activates a workflow
#   containing a Jira Trigger node, the node's webhook lifecycle calls are
#   routed here instead of to a real Jira instance.
#
#   The credential is created with:
#     type:   "jiraSoftwareCloudApi"
#     domain: "http://mock-jira:8080"   <-- points to this nginx mock
#     email:  "test@example.com"        <-- arbitrary, not validated
#     apiToken: "test-api-token"        <-- arbitrary, not validated
#
# ENDPOINTS SERVED:
#
#   The Jira Trigger node makes three API calls during its lifecycle:
#
#   1. GET  /rest/webhooks/1.0/webhook       (checkExists) -> returns []
#      Called on activation to check if a webhook is already registered.
#      We return an empty array so the node proceeds to create one.
#
#   2. POST /rest/webhooks/1.0/webhook       (create)      -> returns webhook object
#      Called on activation to register a new webhook in Jira.
#      We return a fake webhook object with a self URL so the node records
#      the webhook ID in n8n's static data.
#
#   3. DELETE /rest/webhooks/1.0/webhook/{id} (delete)      -> returns 204
#      Called on deactivation to deregister the webhook from Jira.
#      We return 204 No Content so the cleanup succeeds.
#
#   Additionally, n8n validates credentials on save:
#
#   4. GET /rest/api/2/myself                               -> returns user object
#      Called when creating/testing the Jira credential.
#      We return a minimal user object so validation passes.

events {
    worker_connections 64;
}

http {
    server {
        listen 8080;

        # --- Jira Webhook Management API ---

        # GET  /rest/webhooks/1.0/webhook      -> [] (no existing webhooks)
        # POST /rest/webhooks/1.0/webhook      -> created webhook object
        location = /rest/webhooks/1.0/webhook {
            default_type application/json;

            if ($request_method = GET) {
                return 200 '[]';
            }

            if ($request_method = POST) {
                return 201 '{"name":"n8n-mock","url":"http://mock","events":[],"enabled":true,"self":"http://mock-jira:8080/rest/webhooks/1.0/webhook/1"}';
            }

            return 200 '{}';
        }

        # DELETE /rest/webhooks/1.0/webhook/{id} -> 204 No Content
        location ~ ^/rest/webhooks/1.0/webhook/.+ {
            default_type application/json;
            return 204;
        }

        # --- Credential Validation ---
        # n8n tests Jira credentials by calling GET /rest/api/2/myself
        # Return a minimal valid user object so the credential passes validation
        location = /rest/api/2/myself {
            default_type application/json;
            return 200 '{"accountId":"mock-user","emailAddress":"test@example.com","displayName":"Mock Jira User","active":true}';
        }

        # --- Catch-all for any other API calls ---
        location / {
            default_type application/json;
            return 200 '{}';
        }
    }
}
