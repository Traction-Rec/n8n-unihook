# Mock API server for integration tests
#
# WHY THIS IS NEEDED:
#
#   Several n8n trigger nodes unconditionally call their respective external
#   APIs to register/deregister webhooks whenever a workflow is activated or
#   deactivated. This is hardcoded in each node's webhookMethods lifecycle
#   hooks and there is NO environment variable or configuration option to
#   disable it. If these API calls fail, workflow activation fails entirely.
#
#   This single nginx mock provides the minimal set of API responses needed
#   for all trigger node types to activate without real external services.
#
# HOW IT WORKS:
#
#   The test setup script (scripts/run-integration-tests.sh) creates "dud"
#   credentials in n8n with their API endpoints pointed at this mock server
#   (http://mock-apis:8080). When n8n activates a workflow containing a
#   trigger node, the node's webhook lifecycle calls are routed here instead
#   of to the real external service.
#
#   Credentials created:
#     - jiraSoftwareCloudApi  domain:  http://mock-apis:8080
#     - githubApi             server:  http://mock-apis:8080
#
#   All credentials use arbitrary auth values â€” the mock accepts everything.
#
# SERVICES MOCKED:
#
#   Each section below documents the endpoints needed and why.
#   All paths are non-overlapping, so they coexist on a single port.

events {
    worker_connections 64;
}

http {
    server {
        listen 8080;

        # ==================================================================
        # JIRA API MOCK
        # ==================================================================
        #
        # The Jira Trigger node (n8n-nodes-base.jiraTrigger) makes three API
        # calls during its lifecycle:
        #
        #   1. GET  /rest/webhooks/1.0/webhook       (checkExists) -> []
        #   2. POST /rest/webhooks/1.0/webhook       (create)      -> webhook obj
        #   3. DELETE /rest/webhooks/1.0/webhook/{id} (delete)      -> 204
        #
        # Additionally, n8n validates credentials:
        #   4. GET /rest/api/2/myself                               -> user obj

        # GET  -> [] (no existing webhooks)
        # POST -> created webhook object with self URL
        location = /rest/webhooks/1.0/webhook {
            default_type application/json;

            if ($request_method = GET) {
                return 200 '[]';
            }

            if ($request_method = POST) {
                return 201 '{"name":"n8n-mock","url":"http://mock","events":[],"enabled":true,"self":"http://mock-apis:8080/rest/webhooks/1.0/webhook/1"}';
            }

            return 200 '{}';
        }

        # DELETE /rest/webhooks/1.0/webhook/{id} -> 204 No Content
        location ~ ^/rest/webhooks/1.0/webhook/.+ {
            default_type application/json;
            return 204;
        }

        # Jira credential validation
        location = /rest/api/2/myself {
            default_type application/json;
            return 200 '{"accountId":"mock-user","emailAddress":"test@example.com","displayName":"Mock Jira User","active":true}';
        }

        # ==================================================================
        # GITHUB API MOCK
        # ==================================================================
        #
        # The GitHub Trigger node (n8n-nodes-base.githubTrigger) makes three
        # API calls during its lifecycle:
        #
        #   1. GET  /repos/{owner}/{repo}/hooks       (checkExists) -> []
        #   2. POST /repos/{owner}/{repo}/hooks       (create)      -> hook obj
        #   3. DELETE /repos/{owner}/{repo}/hooks/{id} (delete)      -> 204
        #
        # Additionally, n8n validates credentials:
        #   4. GET /user                                             -> user obj

        # GET  -> [] (no existing hooks)
        # POST -> created hook object with id
        # Note: [^/]* (not [^/]+) because n8n may send empty owner/repo
        # segments when the user hasn't filled them in yet, e.g.
        #   POST /repos///hooks
        # We still need to return a valid response so the node doesn't error.
        location ~ ^/repos/[^/]*/[^/]*/hooks$ {
            default_type application/json;

            if ($request_method = GET) {
                return 200 '[]';
            }

            if ($request_method = POST) {
                return 201 '{"id":1,"name":"web","active":true,"events":["push"],"config":{"url":"http://mock","content_type":"json"},"updated_at":"2024-01-01T00:00:00Z","created_at":"2024-01-01T00:00:00Z"}';
            }

            return 200 '{}';
        }

        # DELETE /repos/{owner}/{repo}/hooks/{id} -> 204 No Content
        location ~ ^/repos/[^/]*/[^/]*/hooks/[0-9]+$ {
            default_type application/json;
            return 204;
        }

        # GitHub credential validation
        location = /user {
            default_type application/json;
            return 200 '{"login":"test-user","id":1,"type":"User","name":"Mock GitHub User"}';
        }

        # ==================================================================
        # CATCH-ALL
        # ==================================================================
        # Return empty JSON for any unexpected API calls so nothing breaks
        # silently. Add new service sections above this block.

        location / {
            default_type application/json;
            return 200 '{}';
        }
    }
}
